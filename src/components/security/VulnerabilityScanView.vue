<template>
  <div class="vulnerability-scan-view">
    <div class="view-header">
      <div>
        <h2 class="view-title">Vulnerability Scanner</h2>
        <p class="view-subtitle">Scan and manage system vulnerabilities</p>
      </div>
      <div class="header-actions">
        <button
          @click="showScanModal = true"
          :disabled="scanning"
          class="btn btn-primary"
        >
          <i class="fas fa-search"></i>
          {{ scanning ? 'Scanning...' : 'Run New Scan' }}
        </button>
      </div>
    </div>

    <!-- Last Scan Info -->
    <div v-if="lastScanDate" class="last-scan-info">
      <i class="fas fa-clock"></i>
      Last scan: {{ formatDate(lastScanDate) }}
    </div>

    <!-- Scanning Progress -->
    <div v-if="scanning" class="scanning-progress">
      <div class="progress-bar-container">
        <div class="progress-bar-animated"></div>
      </div>
      <p class="progress-text">
        <i class="fas fa-spinner fa-spin"></i>
        Scanning system for vulnerabilities...
      </p>
    </div>

    <!-- Vulnerability Statistics -->
    <div class="stats-row">
      <div class="vuln-stat critical">
        <span class="stat-value">{{ criticalCount }}</span>
        <span class="stat-label">Critical</span>
      </div>
      <div class="vuln-stat high">
        <span class="stat-value">{{ highCount }}</span>
        <span class="stat-label">High</span>
      </div>
      <div class="vuln-stat medium">
        <span class="stat-value">{{ mediumCount }}</span>
        <span class="stat-label">Medium</span>
      </div>
      <div class="vuln-stat low">
        <span class="stat-value">{{ lowCount }}</span>
        <span class="stat-label">Low</span>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
      <div class="filter-group">
        <label for="severityFilter">Severity:</label>
        <select id="severityFilter" v-model="selectedSeverity" class="filter-select">
          <option value="all">All Severities</option>
          <option value="Critical">Critical</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="statusFilter">Status:</label>
        <select id="statusFilter" v-model="selectedStatus" class="filter-select">
          <option value="all">All</option>
          <option value="open">Open</option>
          <option value="resolved">Resolved</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="searchInput">Search:</label>
        <input
          id="searchInput"
          type="text"
          v-model="searchQuery"
          placeholder="Search vulnerabilities..."
          class="filter-input"
        />
      </div>
    </div>

    <!-- Vulnerabilities Table -->
    <div class="table-container">
      <table class="vuln-table">
        <thead>
          <tr>
            <th>Severity</th>
            <th>Title</th>
            <th>Affected Component</th>
            <th>CVE ID</th>
            <th>Discovered</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr v-if="filteredVulnerabilities.length === 0">
            <td colspan="7" class="no-data">No vulnerabilities found</td>
          </tr>
          <tr
            v-for="vuln in filteredVulnerabilities"
            :key="vuln.id"
            @click="selectedVulnerability = vuln"
            class="clickable-row"
          >
            <td>
              <span :class="['severity-badge', `severity-${vuln.severity.toLowerCase()}`]">
                {{ vuln.severity }}
              </span>
            </td>
            <td>
              <strong>{{ vuln.title }}</strong>
            </td>
            <td>{{ vuln.affectedComponent }}</td>
            <td>
              <span v-if="vuln.cveId" class="cve-id">{{ vuln.cveId }}</span>
              <span v-else class="text-muted">N/A</span>
            </td>
            <td>{{ formatDate(vuln.discoveredDate) }}</td>
            <td>
              <span :class="['status-badge', vuln.status === 'resolved' ? 'status-resolved' : 'status-open']">
                {{ vuln.status === 'resolved' ? 'Resolved' : 'Open' }}
              </span>
            </td>
            <td>
              <button class="btn-action" title="View details">
                <i class="fas fa-chevron-right"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Vulnerability Detail Modal -->
    <div v-if="selectedVulnerability" class="modal-overlay" @click.self="selectedVulnerability = null">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <div>
            <h3>{{ selectedVulnerability.title }}</h3>
            <span :class="['severity-badge', `severity-${selectedVulnerability.severity.toLowerCase()}`]">
              {{ selectedVulnerability.severity }}
            </span>
          </div>
          <button @click="selectedVulnerability = null" class="modal-close">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="detail-section">
            <h4>Description</h4>
            <p>{{ selectedVulnerability.description }}</p>
          </div>

          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Affected Component:</span>
              <span class="detail-value">{{ selectedVulnerability.affectedComponent }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">CVE ID:</span>
              <span class="detail-value">{{ selectedVulnerability.cveId || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Discovered:</span>
              <span class="detail-value">{{ formatDate(selectedVulnerability.discoveredDate) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Status:</span>
              <span :class="['status-badge', selectedVulnerability.status === 'resolved' ? 'status-resolved' : 'status-open']">
                {{ selectedVulnerability.status === 'resolved' ? 'Resolved' : 'Open' }}
              </span>
            </div>
          </div>

          <div class="detail-section">
            <h4>Recommendation</h4>
            <p>{{ selectedVulnerability.recommendation }}</p>
          </div>
        </div>

        <div class="modal-actions">
          <button @click="selectedVulnerability = null" class="btn btn-secondary">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Scan Modal -->
    <div v-if="showScanModal" class="modal-overlay" @click.self="showScanModal = false">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Run Vulnerability Scan</h3>
          <button @click="showScanModal = false" class="modal-close">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <Form
          @submit="handleRunScan as any"
          :validation-schema="vulnerabilityScanSchema"
          v-slot="{ errors }"
        >
          <div class="modal-body">
            <div class="form-group">
              <label for="scanType">Scan Type:</label>
              <Field
                id="scanType"
                name="scanType"
                as="select"
                class="form-input"
                :class="{ 'input-error': errors.scanType }"
              >
                <option value="Quick">Quick Scan (3 seconds)</option>
                <option value="Full">Full Scan (8 seconds)</option>
                <option value="Custom">Custom Scan (5 seconds)</option>
              </Field>
              <ErrorMessage name="scanType" class="error-message" />
            </div>

            <div class="form-group">
              <label>Target Components (Optional):</label>
              <Field
                name="targetComponents"
                as="textarea"
                rows="3"
                class="form-input"
                placeholder="Leave empty to scan all components"
              />
              <span class="form-help">Comma-separated list of components to scan</span>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" @click="showScanModal = false" class="btn btn-secondary">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-play"></i>
              Start Scan
            </button>
          </div>
        </Form>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';
import { Form, Field, ErrorMessage } from 'vee-validate';
import { useSecurityManagement } from '@/composables/useSecurityManagement';
import { vulnerabilityScanSchema } from '@/utils/validationSchemas';
import { formatDistanceToNow } from 'date-fns';
import type { Vulnerability, VulnerabilityScanOptions } from '@/types/security';

const {
  vulnerabilities,
  scanning,
  lastScanDate,
  runVulnerabilityScan
} = useSecurityManagement();

const selectedSeverity = ref<string>('all');
const selectedStatus = ref<string>('all');
const searchQuery = ref('');
const showScanModal = ref(false);
const selectedVulnerability = ref<Vulnerability | null>(null);

const filteredVulnerabilities = computed(() => {
  let filtered = [...vulnerabilities.value];

  // Severity filter
  if (selectedSeverity.value !== 'all') {
    filtered = filtered.filter(v => v.severity === selectedSeverity.value);
  }

  // Status filter
  if (selectedStatus.value !== 'all') {
    filtered = filtered.filter(v =>
      selectedStatus.value === 'open' ? v.status !== 'resolved' : v.status === 'resolved'
    );
  }

  // Search filter
  if (searchQuery.value) {
    const query = searchQuery.value.toLowerCase();
    filtered = filtered.filter(v =>
      v.title.toLowerCase().includes(query) ||
      v.description.toLowerCase().includes(query) ||
      v.affectedComponent.toLowerCase().includes(query) ||
      v.cveId?.toLowerCase().includes(query)
    );
  }

  // Sort by severity and date
  const severityOrder = { Critical: 0, High: 1, Medium: 2, Low: 3, Info: 4 };
  return filtered.sort((a, b) => {
    const severityDiff = severityOrder[a.severity] - severityOrder[b.severity];
    if (severityDiff !== 0) return severityDiff;
    return b.discoveredDate.getTime() - a.discoveredDate.getTime();
  });
});

const criticalCount = computed(() =>
  vulnerabilities.value.filter(v => v.severity === 'Critical' && v.status !== 'resolved').length
);
const highCount = computed(() =>
  vulnerabilities.value.filter(v => v.severity === 'High' && v.status !== 'resolved').length
);
const mediumCount = computed(() =>
  vulnerabilities.value.filter(v => v.severity === 'Medium' && v.status !== 'resolved').length
);
const lowCount = computed(() =>
  vulnerabilities.value.filter(v => v.severity === 'Low' && v.status !== 'resolved').length
);

const formatDate = (date: Date): string => {
  return formatDistanceToNow(date, { addSuffix: true });
};

const handleRunScan = async (values: VulnerabilityScanOptions) => {
  await runVulnerabilityScan(values);
  showScanModal.value = false;
};
</script>

<style scoped>
.vulnerability-scan-view {
  padding: 1.5rem;
}

.view-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 1rem;
  gap: 1rem;
}

.view-title {
  font-size: 1.75rem;
  font-weight: 700;
  color: #1a202c;
  margin-bottom: 0.5rem;
}

.view-subtitle {
  font-size: 0.95rem;
  color: #718096;
}

.last-scan-info {
  background: #ebf8ff;
  padding: 0.75rem 1rem;
  border-radius: 0.5rem;
  font-size: 0.875rem;
  color: #2c5282;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.scanning-progress {
  background: white;
  padding: 1.5rem;
  border-radius: 0.5rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.progress-bar-container {
  height: 8px;
  background: #e2e8f0;
  border-radius: 9999px;
  overflow: hidden;
  margin-bottom: 1rem;
}

.progress-bar-animated {
  height: 100%;
  background: linear-gradient(90deg, #4299e1, #667eea);
  border-radius: 9999px;
  animation: progress-animation 1.5s ease-in-out infinite;
}

@keyframes progress-animation {
  0% { width: 0%; }
  50% { width: 70%; }
  100% { width: 100%; }
}

.progress-text {
  text-align: center;
  color: #4a5568;
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.vuln-stat {
  background: white;
  padding: 1.25rem;
  border-radius: 0.5rem;
  text-align: center;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border-left: 4px solid;
}

.vuln-stat.critical {
  border-left-color: #f56565;
}

.vuln-stat.high {
  border-left-color: #ed8936;
}

.vuln-stat.medium {
  border-left-color: #ecc94b;
}

.vuln-stat.low {
  border-left-color: #4299e1;
}

.stat-value {
  display: block;
  font-size: 2rem;
  font-weight: 700;
  color: #1a202c;
  margin-bottom: 0.25rem;
}

.stat-label {
  display: block;
  font-size: 0.75rem;
  color: #718096;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.filters-section {
  background: white;
  padding: 1.5rem;
  border-radius: 0.5rem;
  margin-bottom: 1.5rem;
  display: flex;
  gap: 1.5rem;
  flex-wrap: wrap;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  min-width: 200px;
  flex: 1;
}

.filter-group label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #4a5568;
}

.filter-select,
.filter-input {
  padding: 0.5rem 0.75rem;
  border: 1px solid #e2e8f0;
  border-radius: 0.375rem;
  font-size: 0.875rem;
}

.filter-select:focus,
.filter-input:focus {
  outline: none;
  border-color: #4299e1;
}

.table-container {
  background: white;
  border-radius: 0.5rem;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.vuln-table {
  width: 100%;
  border-collapse: collapse;
}

.vuln-table thead {
  background: #f7fafc;
}

.vuln-table th {
  padding: 0.75rem 1rem;
  text-align: left;
  font-size: 0.75rem;
  font-weight: 600;
  color: #718096;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 1px solid #e2e8f0;
}

.vuln-table td {
  padding: 0.75rem 1rem;
  font-size: 0.875rem;
  color: #2d3748;
  border-bottom: 1px solid #e2e8f0;
}

.clickable-row {
  cursor: pointer;
  transition: background 0.2s;
}

.clickable-row:hover {
  background: #f7fafc;
}

.no-data {
  text-align: center;
  color: #a0aec0;
  padding: 2rem !important;
}

.severity-badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.severity-critical {
  background: #fed7d7;
  color: #742a2a;
}

.severity-high {
  background: #feebc8;
  color: #7c2d12;
}

.severity-medium {
  background: #fefcbf;
  color: #744210;
}

.severity-low {
  background: #bee3f8;
  color: #2c5282;
}

.status-badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.status-open {
  background: #fed7d7;
  color: #c53030;
}

.status-resolved {
  background: #c6f6d5;
  color: #22543d;
}

.cve-id {
  font-family: 'Courier New', monospace;
  background: #edf2f7;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.75rem;
}

.text-muted {
  color: #a0aec0;
}

.btn-action {
  background: none;
  border: none;
  padding: 0.25rem 0.5rem;
  cursor: pointer;
  color: #718096;
}

.btn-action:hover {
  color: #4299e1;
}

.btn {
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-primary {
  background: #4299e1;
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: #3182ce;
}

.btn-secondary {
  background: white;
  color: #4a5568;
  border: 1px solid #e2e8f0;
}

.btn-secondary:hover {
  background: #f7fafc;
}

/* Modal Styles */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
}

.modal-content {
  background: white;
  border-radius: 0.5rem;
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

.modal-large {
  max-width: 700px;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  padding: 1.5rem;
  border-bottom: 1px solid #e2e8f0;
  gap: 1rem;
}

.modal-header h3 {
  font-size: 1.25rem;
  font-weight: 700;
  color: #1a202c;
  margin-bottom: 0.5rem;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.25rem;
  color: #718096;
  cursor: pointer;
  padding: 0.25rem;
  flex-shrink: 0;
}

.modal-close:hover {
  color: #2d3748;
}

.modal-body {
  padding: 1.5rem;
}

.detail-section {
  margin-bottom: 1.5rem;
}

.detail-section h4 {
  font-size: 1rem;
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 0.75rem;
}

.detail-section p {
  color: #4a5568;
  line-height: 1.6;
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.detail-item {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.detail-label {
  font-size: 0.75rem;
  font-weight: 600;
  color: #718096;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.detail-value {
  font-size: 0.875rem;
  color: #2d3748;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  font-size: 0.875rem;
  font-weight: 600;
  color: #4a5568;
  margin-bottom: 0.5rem;
}

.form-input {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid #e2e8f0;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-family: inherit;
}

.form-input:focus {
  outline: none;
  border-color: #4299e1;
}

.form-input.input-error {
  border-color: #e53e3e;
}

.form-help {
  display: block;
  font-size: 0.75rem;
  color: #a0aec0;
  margin-top: 0.25rem;
}

.error-message {
  display: block;
  font-size: 0.75rem;
  color: #e53e3e;
  margin-top: 0.25rem;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
  padding: 1.5rem;
  border-top: 1px solid #e2e8f0;
}

/* Responsive Design */
@media (max-width: 768px) {
  .vulnerability-scan-view {
    padding: 1rem;
  }

  .view-header {
    flex-direction: column;
  }

  .stats-row {
    grid-template-columns: repeat(2, 1fr);
  }

  .filters-section {
    flex-direction: column;
  }

  .table-container {
    overflow-x: auto;
  }

  .vuln-table {
    min-width: 900px;
  }

  .detail-grid {
    grid-template-columns: 1fr;
  }
}
</style>




